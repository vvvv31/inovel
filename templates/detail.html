{% extends "base.html" %}

{% block title %}{{ novel.title }} - è¯¦æƒ…{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-md-3">
      <img src="{{ novel.cover }}" class="img-fluid" alt="{{ novel.title }}" style="border-radius: 8px;">
    </div>
    <div class="col-md-9">
      <h1>{{ novel.title }}</h1>
      <p><strong>ä½œè€…ï¼š</strong>{{ novel.author }}</p>
      <p><strong>ç±»å‹ï¼š</strong>{{ novel.genre }}</p>
      <p><strong>çŠ¶æ€ï¼š</strong>{{ novel.status }}</p>
      <p><strong>æ›´æ–°æ—¶é—´ï¼š</strong>{{ novel.updateTime }}</p>
      <p><strong>é˜…è¯»é‡ï¼š</strong>{{ novel.views }} æ¬¡</p>
    </div>
  </div>

  <div class="mt-4">
    <h4>ç®€ä»‹</h4>
    <p>{{ novel.description }}</p>
  </div>

  <!-- æ”¶è—åŠŸèƒ½ -->
  {% if session.logged_in %}
    <form action="/toggle_favorite" method="post" style="margin: 1rem 0;">
      <input type="hidden" name="novel_id" value="{{ novel.id }}">
      {% if novel.id in user_favorites %}
        <button class="btn btn-danger">â¤ï¸ å·²æ”¶è—</button>
      {% else %}
        <button class="btn btn-outline-danger">â• æ”¶è—å°è¯´</button>
      {% endif %}
    </form>
  {% else %}
    <p><a href="/login" class="btn btn-link">ğŸ” ç™»å½•åå¯æ”¶è—å°è¯´</a></p>
  {% endif %}

  <!-- ç›®å½• -->
  <h4 class="mt-4">ğŸ“– ç›®å½•</h4>
  <ul class="list-group">
    {% for chapter in novel.chapters %}
      <li class="list-group-item">
        <a href="/read/{{ novel.id }}/{{ chapter.id }}">{{ chapter.title }}</a>
      </li>
    {% endfor %}
  </ul>

  <p class="mt-3"><a href="/">â† è¿”å›é¦–é¡µ</a></p>

<!-- ========== è¯„è®ºåŒºå¼€å§‹ ========== -->
  <div class="comment-section mt-5">
    <div class="comment-header">å°è¯´è¯„è®º (<span id="comment-count">{{ comments | length }}</span>)</div>
    <div class="comment-list">
      {% if comments %}
        {% for comment in comments %}
          <!-- åªæ˜¾ç¤ºé’ˆå¯¹å°è¯´çš„è¯„è®ºï¼ˆéç« èŠ‚è¯„è®ºï¼‰ -->
          {% if comment.chapter_id is none %}
          <div class="comment-item">
            <div class="comment-content">
              <div class="comment-author">{{ comment.username }}</div>
              <div class="comment-meta">{{ comment.timestamp }}</div>
              <div class="comment-text">{{ comment.content }}</div>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="p-3 text-muted">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>
      {% endif %}
    </div>

    <!-- è¯„è®ºè¡¨å• -->
    {% if session.logged_in %}
      <form method="POST" action="/add_comment" class="comment-form">
        <input type="hidden" name="novel_id" value="{{ novel.id }}">
        <input type="hidden" name="chapter_id" value=""> <!-- ç•™ç©ºè¡¨ç¤ºæ˜¯å°è¯´è¯„è®º -->
        <textarea name="content" placeholder="å‘è¡¨å¯¹è¿™æœ¬å°è¯´çš„çœ‹æ³•..." class="form-control"></textarea>
        <button type="submit" class="btn btn-primary mt-2">å‘è¡¨è¯„è®º</button>
      </form>
    {% else %}
      <div class="comment-form">
        <p class="text-muted text-center mb-0">ç™»å½•åå¯å‘è¡¨è¯„è®º</p>
      </div>
    {% endif %}
  </div>
  <!-- ========== è¯„è®ºåŒºç»“æŸ ========== -->
{% endblock %}