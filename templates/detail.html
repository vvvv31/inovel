{% extends "base.html" %}

{% block title %}{{ novel.title }} - 详情{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-md-3">
      <img src="{{ novel.cover }}" class="img-fluid" alt="{{ novel.title }}" style="border-radius: 8px;">
    </div>
    <div class="col-md-9">
      <h1>{{ novel.title }}</h1>
      <p><strong>作者：</strong>{{ novel.author }}</p>
      <p><strong>类型：</strong>{{ novel.genre }}</p>
      <p><strong>状态：</strong>{{ novel.status }}</p>
      <p><strong>更新时间：</strong>{{ novel.updateTime }}</p>
      <p><strong>阅读量：</strong>{{ novel.views }} 次</p>
    </div>
  </div>

  <div class="mt-4">
    <h4>简介</h4>
    <p>{{ novel.description }}</p>
  </div>

  <!-- 收藏功能 -->
  {% if session.logged_in %}
    <form action="/toggle_favorite" method="post" style="margin: 1rem 0;">
      <input type="hidden" name="novel_id" value="{{ novel.id }}">
      {% if novel.id in user_favorites %}
        <button class="btn btn-danger">❤️ 已收藏</button>
      {% else %}
        <button class="btn btn-outline-danger">➕ 收藏小说</button>
      {% endif %}
    </form>
  {% else %}
    <p><a href="/login" class="btn btn-link">🔐 登录后可收藏小说</a></p>
  {% endif %}

  <!-- 目录 -->
  <h4 class="mt-4">📖 目录</h4>
  <ul class="list-group">
    {% for chapter in novel.chapters %}
      <li class="list-group-item">
        <a href="/read/{{ novel.id }}/{{ chapter.id }}">{{ chapter.title }}</a>
      </li>
    {% endfor %}
  </ul>

  <p class="mt-3"><a href="/">← 返回首页</a></p>

<!-- ========== 评论区开始 ========== -->
  <div class="comment-section mt-5">
    <div class="comment-header">小说评论 (<span id="comment-count">{{ comments | length }}</span>)</div>
    <div class="comment-list">
      {% if comments %}
        {% for comment in comments %}
          <!-- 只显示针对小说的评论（非章节评论） -->
          {% if comment.chapter_id is none %}
          <div class="comment-item">
            <div class="comment-content">
              <div class="comment-author">{{ comment.username }}</div>
              <div class="comment-meta">{{ comment.timestamp }}</div>
              <div class="comment-text">{{ comment.content }}</div>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="p-3 text-muted">暂无评论，快来发表第一条评论吧！</div>
      {% endif %}
    </div>

    <!-- 评论表单 -->
    {% if session.logged_in %}
      <form method="POST" action="/add_comment" class="comment-form">
        <input type="hidden" name="novel_id" value="{{ novel.id }}">
        <input type="hidden" name="chapter_id" value=""> <!-- 留空表示是小说评论 -->
        <textarea name="content" placeholder="发表对这本小说的看法..." class="form-control"></textarea>
        <button type="submit" class="btn btn-primary mt-2">发表评论</button>
      </form>
    {% else %}
      <div class="comment-form">
        <p class="text-muted text-center mb-0">登录后可发表评论</p>
      </div>
    {% endif %}
  </div>
  <!-- ========== 评论区结束 ========== -->
{% endblock %}